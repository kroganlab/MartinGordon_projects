---
title: "070224_newPWComparisons"
author: "Martin Gordon"
date: "2024-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Run PW comparisons requested by Aaron; also tidy plots for returning next week

GPR161, SMO, RRL13B, CRHR2, GPR124, GPR135, PTH2R, PDE8A, and PDE8B vs +ciliaPM
-cilia GPR124 and -cilia GPR135 compared to +ciliaPM (does this comparison make sense? include anyway for now but may need to look at a two-way anova instead... otherwise, how do we estimate the individual effects?)

Redo: the QC plots and a PCA of the neg controls removed

```{r cars}
library(magrittr)
library(data.table)
library(circlize)
library(ComplexHeatmap)
library(ggplot2)
library(stringr)
library(randomcoloR)
library(MSstats)
library(ggrepel)
library(readxl)
library(RColorBrewer)
library(cluster) # pam clustering of genes
library(eulerr) # eulerr plot 
library(ggvenn)


source("../../utils/mg_utils/r_utils/IDmapping.R")
source("../../utils/bp_utils/MSstats_Helper_Functions.R")
source("../../utils/bp_utils/ManageScriptData.R")
source ("../../utils/bp_utils/MSstats_V4_Functions.R")
source ("../../utils/bp_utils/UniprotIDMapping.R") #uniprot to gene id mapping
source ("../../utils/bp_utils/enrichmentTestFunctions.R")

source("../../utils/mg_utils/r_utils/plottingHelperFunctions.R")
source("../../utils/mg_utils/r_utils/HelperFunctions.R")

# function to cluster w NA values
clusterWNA <-  function(mat, na.value=0,...){
  
  mat[is.na(mat)] <- na.value
  return(hclust(dist(mat)))
}
```

Run the pw comparisons

```{r}
p.quant <- fread('~/Documents/projects/061324_XFang_Cilia_GPCR/062424_PWComparisons_data/2024_06_26_ProteinLevelQuant.renorm.csv')

# add other annotation information
p.quant[, cilia_present := ifelse(grepl('[-]cilia', GROUP), 'No', 'Yes')]
p.quant[, ag_present := ifelse(grepl('_ag|_In', GROUP), 'Yes', 'No')]
p.quant[, probe := gsub("[-+]{1}cilia_|_ag{1}$|_In{1}$$",'', GROUP)]

p.quant[,.N, by=.(ag_present, cilia_present, probe,GROUP)]

dp.out <- readRDS('./062424_PWComparisons_data/2024_06_24_dp.out.rds')

f.quant <- setDT(dp.out$FeatureLevelData)

p.quant[, SUBJECT := paste0('batch.',SUBJECT)]
p.quant[, LogIntensities := newLogInts]
f.quant[, SUBJECT := paste0('batch.',SUBJECT)]

dp.out$FeatureLevelData <- f.quant
dp.out$ProteinLevelData <- p.quant

```

May want to remove one of the ARL1B cilia + samples (bathc 3 v different to other groups) but hard to say with limited number of samples

```{r}
p.mat <- dcast(p.quant, Protein~interaction(GROUP,SUBJECT), value.var='newLogInts') %>% 
  as.matrix(rownames='Protein')

submat <- sweep(p.mat, 1, apply(p.mat, 1, median, na.rm=T))

hm <- Heatmap(submat, 
        cluster_rows = clusterWNA(submat), 
        column_names_gp = gpar(fontsize=6))

BackupAsPDF(hm, dimensions=c(10,10))

submat <- p.mat[complete.cases(p.mat),]

submat <- sweep(submat, 1, apply(submat, 1, median, na.rm=T))

hm <- Heatmap(submat, 
        cluster_rows = clusterWNA(submat), 
        column_split = gsub('[.][0-9]$','', colnames(submat)),
        column_names_gp = gpar(fontsize=6))

BackupAsPDF(hm, 'complete.heatmap',dimensions=c(10,10))
```


ID mappings file 

```{r}
# lets map the homologs to the mss output and write the complete and tidied data to file 
mh_mappings <- fread('~/Documents/utils/mg_utils/data/mouseHumanIDConversion.txt')
```

Run the comparisons requested

I think we rerun all the contrasts previously generated and share as one file. SHould make it easier to search and draw comparisons

```{r}
                        # control comparisons; background is PM ciliated cells
contrasts.list <- list('+cilia_ARL13b vs +cilia_PM' = data.table(V1="+cilia_ARL13b", V2="+cilia_PM"), # this is our general cilia probe
                       '+cilia_SMO vs +cilia_PM' = data.table(V1='+cilia_SMO', V2='+cilia_PM'),
                       '+cilia_GPR161 vs +cilia_PM' = data.table(V1='+cilia_GPR161', V2='+cilia_PM'),
                       '+cilia_Crhr2 vs +cilia_PM' = data.table(V1='+cilia_Crhr2', V2='+cilia_PM'),
                       '+cilia_GPR124 vs +cilia_PM' = data.table(V1='+cilia_GPR124', V2='+cilia_PM'),
                       '+cilia_GPR135 vs +cilia_PM' = data.table(V1='+cilia_GPR135', V2='+cilia_PM'),
                       '+cilia_Pth2r vs +cilia_PM' = data.table(V1='+cilia_Pth2r', V2='+cilia_PM'),
                       '+cilia_Pde8A vs +cilia_PM' = data.table(V1='+cilia_Pde8A', V2='+cilia_PM'),
                       '+cilia_Pde8B vs +cilia_PM' = data.table(V1='+cilia_Pde8B', V2='+cilia_PM'),
                       
                       # Aaron request: not sure what is wanted by these comparisons... different cell background so difficult to disentangle the variable contributions using this PW approach.. maybe try a two-way ANOVA
                       # these two are novel cilia GPCRs,so interested in seeing if they localize to the cilia? What about comparison in cilia vs no cilia?
                       # general role as PM GPCRs? maybe the question is if these localize to the PM?
                       '-cilia_GPR124 vs +cilia_PM' = data.table(V1='-cilia_GPR124', V2='+cilia_PM'),
                       '-cilia_GPR135 vs +cilia_PM' = data.table(V1='-cilia_GPR135', V2='+cilia_PM'),   
                       
                       # comparisons of +cilia vs -cilia
                       '+cilia_PM vs -cilia_PM' = data.table(V1="+cilia_PM", V2="-cilia_PM"), # what is impact addition of cilia having on PM labelling
                       '+cilia_ARL13b vs -cilia_ARL13b' = data.table(V1="+cilia_ARL13b", V2="-cilia_ARL13b"),
                       '+cilia_SMO vs -cilia_SMO' = data.table(V1='+cilia_SMO', V2='-cilia_SMO'),
                       '+cilia_GPR161 vs -cilia_GPR161' = data.table(V1='+cilia_GPR161', V2='-cilia_GPR161'),
                       '+cilia_GPR124 vs -cilia_GPR124' = data.table(V1='+cilia_GPR124', V2='-cilia_GPR124'),
                       '+cilia_GPR135 vs -cilia_GPR135' = data.table(V1='+cilia_GPR135', V2='-cilia_GPR135'),
                       '+cilia_Pde8A vs -cilia_Pde8A' = data.table(V1='+cilia_Pde8A', V2='-cilia_Pde8A'),
                       '+cilia_Pde8B vs -cilia_Pde8B' = data.table(V1='+cilia_Pde8B', V2='-cilia_Pde8B'),
                       '+cilia_Crhr2 vs -cilia_Crhr2' = data.table(V1='+cilia_Crhr2', V2='-cilia_Crhr2'),
                       '+cilia_Pth2r vs -cilia_Pth2r' = data.table(V1='+cilia_Pth2r', V2='-cilia_Pth2r'),
                       
                       # comparisons of +agonist/antagonist vs +cilia bg
                       '+cilia_SMO_ag vs +cilia_SMO' = data.table(V1='+cilia_SMO_ag', V2='+cilia_SMO'),
                       '+cilia_GPR161_ag vs +cilia_GPR161' = data.table(V1='+cilia_GPR161_ag', V2='+cilia_GPR161'),
                       '+cilia_Pth2r_ag vs +cilia_Pth2r' = data.table(V1='+cilia_Pth2r_ag', V2='+cilia_Pth2r'),
                       '+cilia_Crhr2_ag vs +cilia_Crhr2' = data.table(V1='+cilia_Crhr2_ag', V2='+cilia_Crhr2'),
                       '+cilia_Pde8A_In vs +cilia_Pde8A' = data.table(V1='+cilia_Pde8A_In', V2='+cilia_Pde8A'),
                       '+cilia_Pde8B_In vs +cilia_Pde8B' = data.table(V1='+cilia_Pde8B_In', V2='+cilia_Pde8B'),
                       
                       # do we want a ciliated GPCR marker (so natural env) vs -ve cilia PM marker (so 'clean' background)
                       # do comparisons anyway; closest to 'mock' control I guess even if we are confounding background and probe effects
                       '+cilia_ARL13b vs -cilia_PM' = data.table(V1="+cilia_ARL13b", V2="-cilia_PM"), # this is our general cilia probe
                       '+cilia_SMO vs -cilia_PM' = data.table(V1='+cilia_SMO', V2='-cilia_PM'),
                       '+cilia_GPR161 vs -cilia_PM' = data.table(V1='+cilia_GPR161', V2='-cilia_PM'),
                       '+cilia_Crhr2 vs -cilia_PM' = data.table(V1='+cilia_Crhr2', V2='-cilia_PM'),
                       '+cilia_GPR124 vs -cilia_PM' = data.table(V1='+cilia_GPR124', V2='-cilia_PM'),
                       '+cilia_GPR135 vs -cilia_PM' = data.table(V1='+cilia_GPR135', V2='-cilia_PM'),
                       '+cilia_Pth2r vs -cilia_PM' = data.table(V1='+cilia_Pth2r', V2='-cilia_PM'),
                       '+cilia_Pde8A vs -cilia_PM' = data.table(V1='+cilia_Pde8A', V2='-cilia_PM'),
                       '+cilia_Pde8B vs -cilia_PM' = data.table(V1='+cilia_Pde8B', V2='-cilia_PM'))


lapply(rownames(contrasts.mat), print)


nrow(contrasts.mat)
```


```{r}
# looks good each row sums to 0
contrasts.mat <- MSstats::MSstatsContrastMatrix(contrasts.list, 
                               conditions = unique(p.quant$GROUP), 
                               labels = names(contrasts.list))
```

Run the comparisons w/wo agonists

```{r}
# run msstats correcting for batch 
mss <- groupComparison(contrast.matrix=contrasts.mat, 
                       verbose=T,
                       data=dp.out)

mss.dt <- setDT(mss$ComparisonResult)
```

Leave for now 
```{r}
#table of N detected per feature
nCounts.dt <- p.quant[, .SD[, .(numeratorCounts=.N, denominatorCounts=.N)], by=.(Protein,GROUP)]

# maybe the easiest way is to split label in mss.dt into denominator and numerator, and then match label in this datatable and just take the sum of measurements
mss.dt[, c('numerator', 'denomimator') :=  tstrsplit(Label, ' vs ', keep=c(1,2))]
mss.dt <- merge(x=mss.dt, y=nCounts.dt[,.(Protein, GROUP, numeratorCounts)], by.x=c('numerator','Protein'), by.y=c('GROUP','Protein'), all.x=T)
mss.dt <- merge(x=mss.dt, y=nCounts.dt[,.(Protein, GROUP, denominatorCounts)], by.x=c('denomimator','Protein'), by.y=c('GROUP','Protein'), all.x=T)
```

process the msstats output
```{r}
# write out raw results
mss.dt[, gene := multiUniprots2multiGenes(as.character(Protein), species = 'MOUSE')]
mss.dt[, p.adj := p.adjust(pvalue, method='BH'), by=.(Label)]


# add another sig term for one condition missing 
mss.dt[, sig := 'not']
# this is our default threshold for significance
mss.dt[abs(log2FC) > 1 & p.adj < 0.05, sig := ifelse(log2FC > 0, 'up', 'down')]
# second threshold; must be present in at least all reps for one group
mss.dt[issue == 'oneConditionMissing' & (!(is.na(numeratorCounts) & numeratorCounts == 3) | !(is.na(denominatorCounts) & denominatorCounts == 3)), sig := 'oneConditionMissing']

# merge with human ID table
anno.dt <- merge(mss.dt, unique(mh_mappings[,.(SWISS_PROT_IDs.mouse, SWISS_PROT_IDs.human,Symbol.human)], by='SWISS_PROT_IDs.mouse'), by.x='Protein', by.y='SWISS_PROT_IDs.mouse', all.x=T, all.y=F)
```

Write out the data
```{r}
#fwrite(anno.dt, ScriptAndDatedFileName('all.mss.pwComparisons.csv'))
#fwrite(anno.dt[, .(Protein,gene,Symbol.human,Label, denomimator, denominatorCounts, numerator, numeratorCounts, log2FC, pvalue, adj.pvalue, issue)], ScriptAndDatedFileName('all.mss.pwComparisons.toShare.csv'))
#fwrite(dcast(anno.dt, gene+Protein+Symbol.human~Label, value.var = c('log2FC','pvalue', 'p.adj')), ScriptAndDatedFileName('all.mss.pwComparisons.wide.csv'))
```

Read in the MSS output


```{r}
mss.dt <- fread('./070224_newPWComparisons_data/2024_07_03_all.mss.pwComparisons.csv')
```

```{r}
# need label for contrastType so we can distinguish the groups for facetting

mss.dt[, contrastGrp :=  ifelse(grepl('[+]cilia_PM', denomimator), 'Cilia_PM_denominator', 
                                                   ifelse(Label %in% c("+cilia_ARL13b vs -cilia_ARL13b","+cilia_SMO vs -cilia_SMO",
                                                                       "+cilia_GPR161 vs -cilia_GPR161","+cilia_GPR124 vs -cilia_GPR124",
                                                                       "+cilia_GPR135 vs -cilia_GPR135","+cilia_Pde8A vs -cilia_Pde8A",
                                                                       "+cilia_Pde8B vs -cilia_Pde8B","+cilia_Crhr2 vs -cilia_Crhr2",
                                                                       "+cilia_Pth2r vs -cilia_Pth2r"), 'noCilia_denominator',
                                                          ifelse(Label %in% c("+cilia_SMO_ag vs +cilia_SMO", "+cilia_GPR161_ag vs +cilia_GPR161",
                                                                              "+cilia_Pth2r_ag vs +cilia_Pth2r","+cilia_Crhr2_ag vs +cilia_Crhr2",
                                                                              "+cilia_Pde8A_In vs +cilia_Pde8A","+cilia_Pde8B_In vs +cilia_Pde8B"), 'noLigand_denominator',
                                                                 ifelse(grepl('[-]cilia_PM', denomimator), 'noCilia_PM_denominator',  'Cilia_bgSignal'))))]

# looks fine; PMcilia+ vs PMcilia- grouped into noCilia_PM_denominator
mss.dt[,.N, .(contrastGrp,Label)][order(contrastGrp)]
```
barplots of sig hits
```{r}
g <- ggplot(mss.dt[sig != 'not', .N, by=.(sig,Label)], aes(x=reorder(Label, -N), y=N, fill=sig)) +
  geom_bar(stat='Identity') +
  ggtitle('Significant hits per contrast (log2FC > 1 & p.adjust < 0.05)') +
  xlab('Contrast') +
  ylab('Number sig hits') +
  scale_fill_manual(values=c('down'=('blue'), 'up'=('red'), 'oneConditionMissing'=('grey'))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90,size=10))
g
BackupAsPDF(g, './NsigHitsplots/sigHits.allContrasts.barplot', dimensions=c(12,10))

# facet by denominator
g <- ggplot(mss.dt[sig != 'not', .N, by=.(sig,Label, contrastGrp)], aes(x=reorder(Label, -N), y=N, fill=sig)) +
  geom_bar(stat='Identity') +
  ggtitle('Significant hits per contrast (log2FC > 1 & p.adjust < 0.05)') +
  xlab('Contrast') +
  ylab('Number sig hits') +
  facet_wrap(~contrastGrp, scales='free') +
  scale_fill_manual(values=c('up'='#990033', 'down'='#336699', 'oneConditionMissing'='grey')) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90,size=10))
g
BackupAsPDF(g, './NsigHitsplots/sigHits.allContrasts.contrastGrpFacet.barplot', dimensions=c(12,8))

# loop over contrast groups to make it clearer
lapply(unique(mss.dt$contrastGrp), function(x){
  
  g <- ggplot(mss.dt[contrastGrp == x & sig != 'not', .N, by=.(sig,Label)], aes(x=reorder(Label, -N), y=N, fill=sig)) +
    geom_bar(stat='Identity') +
    ggtitle(paste0(x, ' significant hits')) +
    xlab('Contrast') +
    ylab('Counts (log2FC > 1 & p.adj < 0.05)') +
    scale_fill_manual(values=c('up'='#990033', 'down'='#336699', 'oneConditionMissing'='grey')) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=90,size=10))
  g
 BackupAsPDF(g, paste0(x,'.NsigHits.barplot'), dimensions=c(8,6))
})
```

```{r}

# loop over contrast groups to make it clearer
lapply(unique(mss.dt$contrastGrp), function(x){
  
 g <- ggplot(mss.dt[contrastGrp == x & !is.infinite(-log10(adj.pvalue)),], aes(x=log2FC, y=-log10(adj.pvalue), col=sig, label=gene)) +
  geom_point() + 
  ylab('-log10 adjusted p-value') +
  ggrepel::geom_text_repel(data=mss.dt[contrastGrp == x & sig != 'not' & !is.infinite(-log10(adj.pvalue)),], show.legend = FALSE, size = 2, max.overlaps = 20) +
  ggtitle(paste0(x, ' comparisons')) +
  geom_vline(xintercept = c(-1,1), linetype=2, alpha=0.4) +
  geom_hline(yintercept = -log10(0.05), linetype=2, alpha=0.4) +
  scale_color_manual(values=c('up'='#990033', 'down'='#336699', 'not'='grey')) +
  facet_wrap(~Label, scales='free', ncol=3) +
  theme_bw()
  g
 BackupAsPDF(g, paste0('./Volcanoplots/', x, '.contrasts.controls.volcano'), dimensions=c(10,10))
 })

```

```{r}
# subplot of the noLigand denom group
# adjust the thresholds to visualise differences
subDT <- mss.dt[contrastGrp == 'noLigand_denominator',]

subDT[,sig := 'not']
subDT[abs(log2FC) > 0.58 & pvalue < 0.005, sig := ifelse(log2FC > 0, 'up', 'down')]
subDT[sig != 'not' & issue == 'oneConditionMissing' & (numeratorCounts == 3 | denominatorCounts == 3), sig := 'oneConditionMissing']

# replot the noLigand comparisons with an adjusted significance threshold to change
g <- ggplot(subDT, aes(x=log2FC, y=-log10(pvalue), col=sig, label=gene)) +
  geom_point() + 
  ylab('-log10 adjusted p-value') +
  ggrepel::geom_text_repel(data=subDT[sig !='not',], show.legend = FALSE, size = 2, max.overlaps = 15) +
  ggtitle('FC +/- 50% & pval < 0.005') +
  geom_vline(xintercept = c(-0.58,0.58), linetype=2, alpha=0.4) +
  geom_hline(yintercept = -log10(0.005), linetype=2, alpha=0.4) +
  scale_color_manual(values=c('up'='#990033', 'down'='#336699', 'not'='grey')) +
  facet_wrap(~Label, scales='free') +
  theme_bw()
g
BackupAsPDF(g, paste0('./Volcanoplots/noLigand_denominator.fc.58.pval0.005.contrasts.controls.volcano'), dimensions=c(16,12))
```
```{r}

```



Get some of the cilia annotated proteins; lets see how they look in the data
Recover the literature-annotated proteins
```{r}
# add our sig hits to a list
sig.list <- mss.dt[sig == 'up',.(Label,gene,Protein)] %>% 
  split(., by='Label')

sig.prots <- lapply(sig.list, function(x){
  return(unique(x[, Protein]))
})

#read in literature sig hits
cilia.Nachury.2021 <- read_xlsx(path='./docs/ciliaProteins.Nachury.etal.2021.xlsx', sheet=1, skip = 1)$`Gene Symbol`
cilia.Nachury.2021 <- cilia.Nachury.2021[!is.na(cilia.Nachury.2021)]
cilia.Nachury.2021 <- translateGeneName2Uniprot(cilia.Nachury.2021, species='MOUSE')
cilia.Nachury.2021 <- cilia.Nachury.2021[!is.na(cilia.Nachury.2021)]

cilia.Nachury.2015.highConf <- read_xlsx(path='./docs/Nachury.etal.2015cilliaProteins.xlsx', sheet=1)$`Uniprot accession number`
#cilia.Nachury.2015.highConf <- multiUniprots2multiGenes(cilia.Nachury.2015.highConf, species='MOUSE')

cilia.literature <- list('Nachury et al 2021' = cilia.Nachury.2021,
                         'Nachury et al 2015 (High Conf)' = cilia.Nachury.2015.highConf)

# rewmove duplciates
cilia.literature <- lapply(cilia.literature, unique)
cilia.literature <- lapply(cilia.literature, function(x){x[!is.na(x)]})

lit.prots <- unique(unlist(cilia.literature))

```

heatmaps of the significant genes in each of the group contrasts

```{r}
# change thresholds for the noLigand group as nothing passing significance
mss.dt[contrastGrp == 'noLigand_denominator', sig := 'not']
mss.dt[contrastGrp == 'noLigand_denominator' & abs(log2FC) > 0.58 & pvalue < 0.005, sig := ifelse(log2FC > 0, 'up', 'down')]


lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  message(paste0('finding unique groups in the following contrasts... ', mss.dt[contrastGrp == x, unique(Label)], '\n'))
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig %in% c('down', 'up', 'oneConditionMissing'), Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'LogIntensities') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  print(colnames(submat))
  
  rownames(submat) <- multiUniprots2multiGenes(rownames(submat), species='MOUSE')
  
  hm <- Heatmap(submat, 
              cluster_rows = clusterWNA(submat),
              cluster_columns=F,
              name='Ints./Median',
              border = T,
              column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
              #row_names_gp = gpar(fontsize=6),
              show_row_names =F,
              row_title = sprintf('%s DE proteins', nrow(submat)),
              column_title_gp = gpar(fontsize=8),
              column_names_gp = gpar(fontsize=6))

  #BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.medianScaled.heatmap'), dimensions = c(14,18))
})
```
Regenerate the heatmaps with a more stringent FC threshold (better recovery of TP identifications?)
Lets try log2FC 4
```{r}
lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  message(paste0('finding unique groups in the following contrasts... ', mss.dt[contrastGrp == x, unique(Label)], '\n'))
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig %in% c('down', 'up', 'oneConditionMissing') & abs(log2FC) >= 4, Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'LogIntensities') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  print(colnames(submat))
  
  rownames(submat) <- multiUniprots2multiGenes(rownames(submat), species='MOUSE')
  
  hm <- Heatmap(submat, 
              cluster_rows = clusterWNA(submat),
              cluster_columns=F,
              name='Ints./Median',
              border = T,
              column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
              row_names_gp = gpar(fontsize=6),
              show_row_names =T,
              row_title = sprintf('%s DE proteins', nrow(submat)),
              column_title_gp = gpar(fontsize=8),
              column_names_gp = gpar(fontsize=6))

  draw(hm, column_title=x)
  #BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.medianScaled.heatmap'), dimensions = c(14,18))
})
```


I think just run the enrichment on each of the groups and lets check out the output

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')
```

GO BP and GO cellular component
---
Issue with the enrichment results... seems many of these proteins are localized to the Golgi... have they been 
```{r}
# define the universe, the total set of identified genes in our study
universe <- as.character(unique(p.quant$Protein))

mss.dt[, enrich.grp := interaction(Label,sig)]


enrich.dt <- enricherOnGroups(mss.dt[sig %in% c("down","up")], 
                              groupColumns = 'enrich.grp', 
                              geneColumn = "Protein", 
                              term2gene.gmt = gmt.go, 
                              universe = universe)

fwrite(enrich.dt, ScriptAndDatedFileName('allContrasts.GO.BP.enrichments.csv'))


simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
fwrite(simp.enrich$simplified, ScriptAndDatedFileName('allContrasts.GO.BP.simplified.enrichments.csv'))
```
Read in the enrichment results and lets see if we can identify some interesting genes
Use the GO BP results first


Response to ER stress top term in comparisons with both noCilia_Pm and wCilia_PM denominators
response to topologically incorrect protein term also high in both.... suggests degradation/removal of misfolded proteins... these are upreg in all the ciliated probes vs both -cilia and +cilia PM backgrounds...

```{r}
# GO BP enrich
enrich.dt <- fread('~/Documents/projects/061324_XFang_Cilia_GPCR/070224_newPWComparisons_data/2024_07_03_allContrasts.GO.BP.enrichments.csv')
simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
simp.enrich$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]


lapply(unique(mss.dt$contrastGrp[!mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  mss.dt[contrastGrp == x, unique(Label)]


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 4,
                                title=paste0(x, ' GO Biological Process'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  #BackupAsPDF(ht, paste0(x, '.GOBP.enrich.heatmap'), dimensions = c(10,9))
})

# now run the enrichment for the nonLigated denominator comparisons

labels.oi <- mss.dt[contrastGrp == 'noLigand_denominator', unique(Label)]

simp.enrich$simplified[Label %in% labels.oi & p.adjust < 0.1,]

ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 5,
                                max_pAdjust = 0.1,
                                title=paste0('noLigand_denominator GO Biological Process'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 2)
ht
BackupAsPDF(ht, 'noLigand_denominator.GOBP.enrich.heatmap', dimensions = c(10,9))
```

Rerun for the GO CC enrichment results

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='CC', keyType='UNIPROT')
```

I think there is some cilia signal, but its drowned out by all this ER protein turnover related activity..
Maybe we need to try supervised NMF and 'fit' these ER related signals, subtract this and run analysis on the residuals? (Not sure if this will work as possible issue relates to protein localization in the experiment...)

As a simple first pass, lets increase our log2FC thresholds and see if we get better signal
No need to run this on the 'noLigand contrasts as already recovering so few hits...

```{r}
# GO BP enrich
enrich.dt <- fread('~/Documents/projects/061324_XFang_Cilia_GPCR/070224_newPWComparisons_data/2024_07_03_allContrasts.GO.CC.enrichments.csv')
simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
simp.enrich$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]


lapply(unique(mss.dt$contrastGrp[!mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  mss.dt[contrastGrp == x, unique(Label)]


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 8,
                                title=paste0(x, ' GO Cellular Component'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  BackupAsPDF(ht, paste0(x, '.GOCC.enrich.heatmap'), dimensions = c(10,9))
})

# now run the enrichment for the nonLigated denominator comparisons

labels.oi <- mss.dt[contrastGrp == 'noLigand_denominator', unique(Label)]

simp.enrich$simplified[Label %in% labels.oi & p.adjust < 0.1,]

ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 5,
                                max_pAdjust = 0.1,
                                title=paste0('noLigand_denominator GO Cellular Component'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 2)
ht
BackupAsPDF(ht, 'noLigand_denominator.GOCC.enrich.heatmap', dimensions = c(10,9))
```

Rerun enrichment with increased log2FC thresholds

```{r}
# reset sig threshold
mss.dt[contrastGrp != 'noLigand_denominator', sig := 'not']

# we want a 4-fold change in expression
mss.dt[contrastGrp != 'noLigand_denominator' & abs(log2FC) >= 2 & adj.pvalue < 0.05, sig := ifelse(log2FC > 0, 'up', 'down')]

#now, correct for those that have condition missing to only except present in all conditions as a positive result
mss.dt[contrastGrp != 'noLigand_denominator' & sig != 'not' & issue == 'oneConditionMissing', sig := ifelse(numeratorCounts == 3 | denominatorCounts == 3, sig, 'not')]
```
```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')

# define the universe, the total set of identified genes in our study
universe <- as.character(unique(p.quant$Protein))

mss.dt[, enrich.grp := interaction(Label,sig)]


enrich.dt <- enricherOnGroups(mss.dt[sig != 'not'], 
                              groupColumns = 'enrich.grp', 
                              geneColumn = "Protein", 
                              term2gene.gmt = gmt.go, 
                              universe = universe)

fwrite(enrich.dt, ScriptAndDatedFileName('allContrasts.GO.BP.4fold.FC.threshold.enrichments.csv'))


simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
fwrite(simp.enrich$simplified, ScriptAndDatedFileName('allContrasts.GO.BP.4fold.FC.thresholdsimplified.enrichments.csv'))

simp.enrich$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]
```
Now after this has run, lets plot the FCs 
```{r}
lapply(unique(mss.dt$contrastGrp[!mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  mss.dt[contrastGrp == x, unique(Label)]


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 8,
                                title=paste0(x, ' GO Biological Process'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  BackupAsPDF(ht, paste0(x, '.GOBP.enrich.FC4threshold.heatmap'), dimensions = c(11,12))
})
```

Rerun the enrichment for GO CC

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='CC', keyType='UNIPROT')

enrich.dt <- enricherOnGroups(mss.dt[sig != 'not'], 
                              groupColumns = 'enrich.grp', 
                              geneColumn = "Protein", 
                              term2gene.gmt = gmt.go, 
                              universe = universe)

fwrite(enrich.dt, ScriptAndDatedFileName('allContrasts.GO.CC.4fold.FC.threshold.enrichments.csv'))


simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
fwrite(simp.enrich$simplified, ScriptAndDatedFileName('allContrasts.GO.CC.4fold.FC.thresholdsimplified.enrichments.csv'))

simp.enrich$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]
```


```{r}
lapply(unique(mss.dt$contrastGrp[!mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  mss.dt[contrastGrp == x, unique(Label)]


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 8,
                                title=paste0(x, ' GO Cellular Component'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  BackupAsPDF(ht, paste0(x, '.GOCC.enrich.FC4threshold.heatmap'), dimensions = c(11,12))
})
```
I think we should proceed with the 4-fold threshold... seems to do a better job of filtering the DEs to cilia related proteins

Redo the heatmap plots and annotate with proteins annotated to cilia, mislocated and ER group

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='CC', keyType='UNIPROT')
# get the cilium proteins 
cilia.go <- gmt.go[ont == 'cilium', unique(gene)]

gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')

misfold.go <- gmt.go[ont %like% 'response to topologically incorrect protein', unique(gene)] #only ~220 in this set
ERstress.go <- gmt.go[ont %like% 'response to endoplasmic reticulum stress', unique(gene)] #~450 in htis set
```

Replot the heatmaps (using the 4-fold thresholded comparisons first)
```{r}

lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig != 'not', Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  # creating our annotation heatmaps
  cilia_bar <- rownames(submat) %in% cilia.go
  misfold_bar <- rownames(submat) %in% misfold.go
  ER_bar <- rownames(submat) %in% ERstress.go
  
  # add a barplot annotation to show overlap in literature and GO
  names_bar <-  rownames(submat) %in% c(cilia.go, misfold.go, ERstress.go)
  
  hm <- Heatmap(submat, 
                cluster_rows = clusterWNA(submat),
                cluster_columns=F,
                name='Ints./Median',
                border = T,
                column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
                row_names_gp = gpar(fontsize=6),
                show_row_names =T,
                show_column_names = F,
                row_title = sprintf('%s DE proteins', nrow(submat)),
                column_title_gp = gpar(fontsize=9),
                column_names_gp = gpar(fontsize=6)) +
    
    # add anno bar heatmaps
    Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(misfold_bar + 0, name = "Response to topologically incorrect proteins", col = c("0" = "white", "1" = '#FDE725FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +   
    rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  #labels = rownames(submat)[names_bar],
                                  labels = multiUniprots2multiGenes(rownames(submat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 8), padding = unit(0.1, "mm"))) 

  BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.FC4fold.anno.medianScaled.heatmap'), dimensions = c(20,19))
})
```
Ok, lets generate a 'clean' matrix of each of these
Only plot the proteins with no issues (missingness )

```{r}
lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig != 'not' & issue != 'oneConditionMissing', Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  # creating our annotation heatmaps
  cilia_bar <- rownames(submat) %in% cilia.go
  misfold_bar <- rownames(submat) %in% misfold.go
  ER_bar <- rownames(submat) %in% ERstress.go
  
  # add a barplot annotation to show overlap in literature and GO
  names_bar <-  rownames(submat) %in% c(cilia.go, misfold.go, ERstress.go)
  
  hm <- Heatmap(submat, 
                cluster_rows = clusterWNA(submat),
                cluster_columns=F,
                name='Ints./Median',
                border = T,
                column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
                row_names_gp = gpar(fontsize=6),
                show_row_names =T,
                show_column_names = F,
                row_title = sprintf('%s DE proteins', nrow(submat)),
                column_title_gp = gpar(fontsize=9),
                column_names_gp = gpar(fontsize=6)) +
    
    # add anno bar heatmaps
    Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(misfold_bar + 0, name = "Response to topologically incorrect proteins", col = c("0" = "white", "1" = '#FDE725FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +   
    rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  #labels = rownames(submat)[names_bar],
                                  labels = multiUniprots2multiGenes(rownames(submat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 8), padding = unit(0.1, "mm"))) 

  BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.FC4fold.clean.anno.medianScaled.heatmap'), dimensions = c(20,16))
})
```
Replot the complete cases 

```{r}
lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig != 'not' & issue != 'oneConditionMissing', Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  submat <- submat[complete.cases(submat),]
  # creating our annotation heatmaps
  cilia_bar <- rownames(submat) %in% cilia.go
  misfold_bar <- rownames(submat) %in% misfold.go
  ER_bar <- rownames(submat) %in% ERstress.go
  
  # add a barplot annotation to show overlap in literature and GO
  names_bar <-  rownames(submat) %in% c(cilia.go, misfold.go, ERstress.go)
  
  hm <- Heatmap(submat, 
                cluster_rows = clusterWNA(submat),
                cluster_columns=F,
                name='Ints./Median',
                border = T,
                column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
                row_names_gp = gpar(fontsize=6),
                show_row_names =T,
                show_column_names = F,
                row_title = sprintf('%s DE proteins', nrow(submat)),
                column_title_gp = gpar(fontsize=9),
                column_names_gp = gpar(fontsize=6)) +
    
    # add anno bar heatmaps
    Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(misfold_bar + 0, name = "Response to topologically incorrect proteins", col = c("0" = "white", "1" = '#FDE725FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +   
    rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  #labels = rownames(submat)[names_bar],
                                  labels = multiUniprots2multiGenes(rownames(submat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 8), padding = unit(0.1, "mm"))) 

  BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.FC4fold.completeCases.anno.medianScaled.heatmap'), dimensions = c(20,12))
})
```
Lets replot these with our reduced FC thresholds

```{r}
# reset sig threshold
mss.dt[contrastGrp != 'noLigand_denominator', sig := 'not']

# we want a 4-fold change in expression
mss.dt[contrastGrp != 'noLigand_denominator' & abs(log2FC) >= 1 & adj.pvalue < 0.05, sig := ifelse(log2FC > 0, 'up', 'down')]
#now, correct for those that have condition missing to only except present in all conditions as a positive result
mss.dt[contrastGrp != 'noLigand_denominator' & sig != 'not' & issue == 'oneConditionMissing', sig := ifelse(numeratorCounts == 3 | denominatorCounts == 3, sig, 'not')]
```

```{r}
lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig != 'not', Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  # creating our annotation heatmaps
  cilia_bar <- rownames(submat) %in% cilia.go
  misfold_bar <- rownames(submat) %in% misfold.go
  ER_bar <- rownames(submat) %in% ERstress.go
  
  # add a barplot annotation to show overlap in literature and GO
  names_bar <-  rownames(submat) %in% c(cilia.go, misfold.go, ERstress.go)
  
  hm <- Heatmap(submat, 
                cluster_rows = clusterWNA(submat),
                cluster_columns=F,
                name='Ints./Median',
                border = T,
                column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
                row_names_gp = gpar(fontsize=6),
                show_row_names =T,
                show_column_names = F,
                row_title = sprintf('%s DE proteins', nrow(submat)),
                column_title_gp = gpar(fontsize=9),
                column_names_gp = gpar(fontsize=6)) +
    
    # add anno bar heatmaps
    Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(misfold_bar + 0, name = "Response to topologically incorrect proteins", col = c("0" = "white", "1" = '#FDE725FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +   
    rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  #labels = rownames(submat)[names_bar],
                                  labels = multiUniprots2multiGenes(rownames(submat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 6), padding = unit(0.1, "mm"))) 

  BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.FC2fold.anno.medianScaled.heatmap'), dimensions = c(20,21))
})
```
Now generate the clean matrix 

```{r}

lapply(unique(mss.dt$contrastGrp), function(x){
  
  # first, lets extract the groups in this
  
  cond.oi <- unique(unlist(tstrsplit(mss.dt[contrastGrp == x, unique(Label)], ' vs ', keep=c(1,2))))
  
  # now, find the degs in each of the unique contrasts
  prots.oi <- mss.dt[contrastGrp == x & sig != 'not', Protein]
  
  p.mat <- dcast(p.quant[GROUP %in% cond.oi, ], Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
    as.matrix(rownames='Protein')
  
  submat <- p.mat[rownames(p.mat) %in% prots.oi,]
  submat <- sweep(submat, 1, apply(submat, 1, median,na.rm=T))
  
  submat <- submat[complete.cases(submat),]
    
  # creating our annotation heatmaps
  cilia_bar <- rownames(submat) %in% cilia.go
  misfold_bar <- rownames(submat) %in% misfold.go
  ER_bar <- rownames(submat) %in% ERstress.go
  
  # add a barplot annotation to show overlap in literature and GO
  names_bar <-  rownames(submat) %in% c(cilia.go, misfold.go, ERstress.go)
  
  hm <- Heatmap(submat, 
                cluster_rows = clusterWNA(submat),
                cluster_columns=F,
                name='Ints./Median',
                border = T,
                column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
                row_names_gp = gpar(fontsize=6),
                show_row_names =T,
                show_column_names = F,
                row_title = sprintf('%s DE proteins', nrow(submat)),
                column_title_gp = gpar(fontsize=9),
                column_names_gp = gpar(fontsize=6)) +
    
    # add anno bar heatmaps
    Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(misfold_bar + 0, name = "Response to topologically incorrect proteins", col = c("0" = "white", "1" = '#FDE725FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=8, fontface='bold'), column_gap = unit(0.05, "cm"), gap = unit(0.5, "cm"))  +   
    rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  #labels = rownames(submat)[names_bar],
                                  labels = multiUniprots2multiGenes(rownames(submat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 6), padding = unit(0.1, "mm"))) 

  BackupAsPDF(draw(hm, column_title=paste0(x, ' comparisons')), paste0(x, '.sigProts.FC2fold.completeCases.anno.medianScaled.heatmap'), dimensions = c(20,18))
})
```


```{r}

# reset sig threshold
mss.dt[contrastGrp != 'noLigand_denominator', sig := 'not']
# we want a 4-fold change in expression
mss.dt[contrastGrp != 'noLigand_denominator' & abs(log2FC) >= 1 & adj.pvalue < 0.05, sig := ifelse(log2FC > 0, 'up', 'down')]
mss.dt[contrastGrp != 'noLigand_denominator' & sig != 'not' & issue == 'oneConditionMissing', sig := ifelse( (!is.na(numeratorCounts) & numeratorCounts == 3)  | (!is.na(denominatorCounts) & denominatorCounts==3), sig, 'not')]

mss.dt[, lab := sig]
mss.dt[, lab := ifelse(Protein %in% cilia.go, 'cilia', lab)]
mss.dt[, lab := ifelse(Protein %in% ERstress.go, 'ER stress response', lab)]


# loop over contrast groups to make it clearer
lapply(unique(mss.dt$contrastGrp), function(x){
  
 g <- ggplot(mss.dt[contrastGrp == x & !is.infinite(-log10(adj.pvalue)),], aes(x=log2FC, y=-log10(adj.pvalue), col=lab, label=gene)) +
  geom_point(alpha=0.5, size=1) + 
  geom_point(data=mss.dt[contrastGrp == x & Protein %in% c(cilia.go,ERstress.go),]) +
  ylab('-log10 adjusted p-value') +
  ggrepel::geom_text_repel(data=mss.dt[contrastGrp == x & sig != 'not' & !is.infinite(-log10(adj.pvalue)),], show.legend = FALSE, size = 3, max.overlaps = 20) +
  ggtitle(paste0(x, ' comparisons')) +
  geom_vline(xintercept = c(-1,1), linetype=2, alpha=0.4) +
  geom_hline(yintercept = -log10(0.05), linetype=2, alpha=0.4) +
  scale_color_manual(values=c('up'='#990033', 'down'='#336699', 'not'='grey', 'cilia'='#5ec962', 'ER stress response'='#440157FF')) +
  facet_wrap(~Label, scales='free', ncol=3) +
  theme_bw()
  g
  BackupAsPDF(g, paste0('./Volcanoplots/', x, '.contrasts.cilaERanno.volcano'), dimensions=c(12,10))
 })


#replot the other two groups with less things passing significance

g <- ggplot(mss.dt[contrastGrp == 'noLigand_denominator' & !is.infinite(-log10(adj.pvalue)),], aes(x=log2FC, y=-log10(pvalue), col=lab, label=gene)) +
  geom_point(alpha=0.5, size=1) + 
  geom_point(data=mss.dt[contrastGrp == 'noLigand_denominator' & Protein %in% c(cilia.go,ERstress.go),]) +
  ylab('-log10 p-value') +
  ggrepel::geom_text_repel(data=mss.dt[contrastGrp == 'noLigand_denominator' & sig != 'not' & !is.infinite(-log10(adj.pvalue)),], show.legend = FALSE, size = 2, max.overlaps = 20) +
  ggtitle(paste0('noLigand_denominator comparisons (FC +/- 50% pval < 0.005)')) +
  geom_vline(xintercept = c(-0.58,0.58), linetype=2, alpha=0.4) +
  geom_hline(yintercept = -log10(0.005), linetype=2, alpha=0.4) +
  scale_color_manual(values=c('up'='#990033', 'down'='#336699', 'not'='grey', 'cilia'='#5ec962', 'ER stress response'='#440157FF')) +
  facet_wrap(~Label, scales='free', ncol=3) +
  theme_bw()
g
BackupAsPDF(g, './Volcanoplots/noLigand_denominator.reducedThresholds.cilaERanno.volcano', dimensions=c(12,10))
```

replot the no cilia denominator comparisons with adjusted thresholds too; seems to be some shift in the cilia expression group

```{r}
subDT <- mss.dt[contrastGrp == 'noCilia_denominator',]
subDT[, sig := 'not']
subDT[abs(log2FC) >= 0.58 & pvalue < 0.005, sig := ifelse(log2FC > 0, 'up', 'down')]
subDT[sig != 'not' & issue == 'oneConditionMissing', sig := ifelse( (!is.na(numeratorCounts) & numeratorCounts == 3)  | (!is.na(denominatorCounts) & denominatorCounts==3), sig, 'not')]

subDT[, lab := sig]
subDT[, lab := ifelse(Protein %in% cilia.go, 'cilia', lab)]
subDT[, lab := ifelse(Protein %in% ERstress.go, 'ER stress response', lab)]


g <- ggplot(subDT[!is.infinite(-log10(adj.pvalue)),], aes(x=log2FC, y=-log10(pvalue), col=lab, label=gene)) +
  geom_point(alpha=0.5) + 
  geom_point(data=subDT[Protein %in% c(cilia.go,ERstress.go),]) +
  ylab('-log10 p-value') +
  ggrepel::geom_text_repel(data=subDT[sig != 'not' & !is.infinite(-log10(adj.pvalue)),], show.legend = FALSE, size = 2, max.overlaps = 20) +
  ggtitle(paste0('noCilia_denominator comparisons (FC +/- 50% pval < 0.005)')) +
  geom_vline(xintercept = c(-0.58,0.58), linetype=2, alpha=0.4) +
  geom_hline(yintercept = -log10(0.005), linetype=2, alpha=0.4) +
  scale_color_manual(values=c('up'='#990033', 'down'='#336699', 'not'='grey', 'cilia'='#5ec962', 'ER stress response'='#414487FF')) +
  facet_wrap(~Label, scales='free', ncol=3) +
  theme_bw()
g

BackupAsPDF(g, './Volcanoplots/noCilia_denominator.reducedThresholds.cilaERanno.volcano', dimensions=c(16,12))
```
Redo the enrichments to include the missing proteins?
Quick rerun; if results not really changing, drop and generate the other QC plots

```{r}
mss.dt <- fread('./070224_newPWComparisons_data/2024_07_03_all.mss.pwComparisons.csv')
```

```{r}
# need label for contrastType so we can distinguish the groups for facetting
mss.dt[, contrastGrp :=  ifelse(grepl('[+]cilia_PM', denomimator), 'Cilia_PM_denominator', 
                                                   ifelse(Label %in% c("+cilia_ARL13b vs -cilia_ARL13b","+cilia_SMO vs -cilia_SMO",
                                                                       "+cilia_GPR161 vs -cilia_GPR161","+cilia_GPR124 vs -cilia_GPR124",
                                                                       "+cilia_GPR135 vs -cilia_GPR135","+cilia_Pde8A vs -cilia_Pde8A",
                                                                       "+cilia_Pde8B vs -cilia_Pde8B","+cilia_Crhr2 vs -cilia_Crhr2",
                                                                       "+cilia_Pth2r vs -cilia_Pth2r"), 'noCilia_denominator',
                                                          ifelse(Label %in% c("+cilia_SMO_ag vs +cilia_SMO", "+cilia_GPR161_ag vs +cilia_GPR161",
                                                                              "+cilia_Pth2r_ag vs +cilia_Pth2r","+cilia_Crhr2_ag vs +cilia_Crhr2",
                                                                              "+cilia_Pde8A_In vs +cilia_Pde8A","+cilia_Pde8B_In vs +cilia_Pde8B"), 'noLigand_denominator',
                                                                 ifelse(grepl('[-]cilia_PM', denomimator), 'noCilia_PM_denominator',  'Cilia_bgSignal'))))]

# looks fine; PMcilia+ vs PMcilia- grouped into noCilia_PM_denominator
mss.dt[,.N, .(contrastGrp,Label)][order(contrastGrp)]
```
# readjuist sig label to handle missing groups with measurements present in all reps from the other group in the comparison
```{r}
# fixed for all groups but 'noLigand_denominator'
mss.dt[contrastGrp != 'noLigand_denominator', sig := 'not']
mss.dt[contrastGrp != 'noLigand_denominator' & abs(log2FC) >= 1 & adj.pvalue < 0.05, sig := ifelse(log2FC > 0, 'up', 'down')]
mss.dt[contrastGrp != 'noLigand_denominator' & sig != 'not' & issue == 'oneConditionMissing', sig := ifelse( (!is.na(numeratorCounts) & numeratorCounts == 3)  | (!is.na(denominatorCounts) & denominatorCounts==3), sig, 'not')]

# fix noligand_denominator
mss.dt[contrastGrp == 'noLigand_denominator', sig := 'not']
mss.dt[contrastGrp == 'noLigand_denominator' & abs(log2FC) >= 0.58 & pvalue < 0.005, sig := ifelse(log2FC > 0, 'up', 'down')]
mss.dt[contrastGrp == 'noLigand_denominator' & sig != 'not' & issue == 'oneConditionMissing', sig := ifelse( (!is.na(numeratorCounts) & numeratorCounts == 3)  | (!is.na(denominatorCounts) & denominatorCounts==3), sig, 'not')]
```

ok, now lets try rerunnning the enrichments for each

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')
```

```{r}
# define the universe, the total set of identified genes in our study
universe <- as.character(unique(p.quant$Protein))

mss.dt[, enrich.grp := interaction(Label,sig)]


mss.dt[contrastGrp == 'noLigand_denominator' & sig != 'not',] %>% View()


enrich.dt <- enricherOnGroups(mss.dt[sig != 'not'], 
                              groupColumns = 'enrich.grp', 
                              geneColumn = "Protein", 
                              term2gene.gmt = gmt.go, 
                              universe = universe)

simp.enrich <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = enrich.dt, gmt=gmt.go, groupColumn = 'enrich.grp')
```

lets plot the results for each 
V similar enrichment results; doesnt seem that adding in the dropped prots are changing the enrichment profiles. These seem to be dominated by ER stress response/protein misfolding....
```{r}
simp.enrich$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]

lapply(unique(mss.dt$contrastGr), function(x){
  
  labels.oi <-  mss.dt[contrastGrp == x, unique(Label)]


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = simp.enrich$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 8,
                                title=paste0(x, ' GO Cellular Component'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', simp.enrich$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
 # BackupAsPDF(ht, paste0(x, '.GOCC.enrich.allprots.heatmap'), dimensions = c(11,12))
})
```
Rerun the enrichment, including the proteins from the literature in the search

```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')
```

```{r}
# define the universe, the total set of identified genes in our study
universe <- as.character(unique(p.quant$Protein))


lit.prots.enrich <- setDT(as.data.frame(clusterProfiler::enricher(mss.dt[Protein %in% lit.prots, Protein],
                                              pAdjustMethod="fdr",
                                              universe=universe,
                                              TERM2GENE =  gmt.go,
                                              qvalueCutoff = 1.1,
                                              pvalueCutoff = 1.1)))

lit.prots.enrich[,enrich.grp := 'Cilia-localized (Nachury et al 2015,2021)']

enrich.dt <- fread('/Users/martingordon/Documents/projects/061324_XFang_Cilia_GPCR/070224_newPWComparisons_data/2024_07_03_allContrasts.GO.BP.enrichments.csv')

comb.dt <- simplifyEnrichBySimilarUniverseMembership(enrichResultsTable = rbind(lit.prots.enrich, enrich.dt), gmt=gmt.go, groupColumn = 'enrich.grp')
comb.dt$simplified[, Label := gsub('[.]down|[.]up','', enrich.grp)]

comb.dt$simplified[Label == "Cilia-localized (Nachury et al 2015,2021)"]
```

```{r}
lapply(unique(mss.dt$contrastGrp[!mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  c(mss.dt[contrastGrp == x, unique(Label)], "Cilia-localized (Nachury et al 2015,2021)")


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = comb.dt$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 4,
                                title=paste0(x, ' GO Biological Process'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', comb.dt$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  #BackupAsPDF(ht, paste0(x, '.GOBP.enrich.FC2threshold.heatmap'), dimensions = c(7,7))
})
```
plot the no ligand mapping 

```{r}
lapply(unique(mss.dt$contrastGrp[mss.dt$contrastGrp == 'noLigand_denominator']), function(x){
  
  labels.oi <-  c(mss.dt[contrastGrp == x, unique(Label)], "Cilia-localized (Nachury et al 2015,2021)")


  ht <- enrichHeatmapBestPerGroup(simplifiedEnrichTable = comb.dt$simplified[Label %in% labels.oi,], 
                                groupColumn = 'enrich.grp', 
                                topN = 8,
                                title=paste0(x, ' GO Biological Process'), 
                                row_names_gp = gpar(fontsize = 7), 
                                negCols=unique(grep('down', comb.dt$simplified[Label %in% labels.oi, enrich.grp], value=T)),
                                column_names_gp= gpar(fontsize = 6), 
                                upperThreshold = 8)
  ht
  BackupAsPDF(ht, paste0(x, '.GOBP.enrich.FC2threshold.heatmap'), dimensions = c(7,7))
})
```
Write out the PW comparisons results in format for Aaron
Also regenerate the heatmap with all conditions (including missing) so we can see the differences in the groups


Read in the original data
```{r}
mss.dt <- fread('./070224_newPWComparisons_data/2024_07_03_all.mss.pwComparisons.csv')
p.quant <- fread('./062424_PWComparisons_data/2024_06_26_ProteinLevelQuant.renorm.csv')
```

create the pQuant wide format 
```{r}
p.quant[, gene := multiUniprots2multiGenes(Protein, species='MOUSE')]
p.quant.wide <- dcast(p.quant, gene+Protein~paste0(GROUP,'.', SUBJECT), value.var='newLogInts')

fwrite(p.quant.wide, ScriptAndDatedFileName('proteinLevelQuant.csv'))
fread('~/Documents/projects/061324_XFang_Cilia_GPCR/070224_newPWComparisons_data/2024_07_12_proteinLevelQuant.csv')
```
Lets reset the values in sig

```{r}
mss.dt[issue %in% c('oneConditionMissing', 'completeMissing'), sig := 'not']

mss.dt[Protein == 'Q9CQP2' & Label %like% '+cilia_ARL13b',]

mss.dt[issue == 'oneConditionMissing', sig := ifelse(is.na(denominatorCounts), 
                                                     sprintf('Numerator_%s_BioRepsDetected', numeratorCounts), sprintf('Denominator_%s_BioRepsDetected', denominatorCounts))]

mss.dt[issue %in% 'oneConditionMissing', .N, by=.(denominatorCounts,numeratorCounts, sig)] 

# sanity check looks good
mss.dt[issue == 'oneConditionMissing']

fwrite(mss.dt[, .(Protein, gene, Symbol.human, Label, log2FC, SE, pvalue, adj.pvalue, sig, issue, numerator, numeratorCounts, denomimator, denominatorCounts)], ScriptAndDatedFileName('mss.allPWComparisons.csv'))
```
anno data 
```{r}
gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='CC', keyType='UNIPROT')
cilia.go <- gmt.go[ont == 'cilium', unique(gene)]

gmt.go <- loadGmtFromBioconductor(dbName='org.Mm.eg.db', ontology='BP', keyType='UNIPROT')
ER.go <- gmt.go[ont %like% 'response to endoplasmic reticulum stress', unique(gene)]

# read in our sig results
mss.dt <- fread('./070224_newPWComparisons_data/2024_07_03_all.mss.pwComparisons.csv')

# good at least there isnt a lot of overlap in the gene sets... hopefully a different trend across the samples

# high moving ER stress associated genes. I want to use these genes as a subset to 'fit' to 
ER.assoc <- mss.dt[(sig != 'not' & Protein %in% ER.go), unique(Protein)]

# this is our truth set. We want to keep these in our data
cilia.assoc <- mss.dt[(sig != 'not' & Protein %in% cilia.go), unique(Protein)]


# couple of overlapping prots: in the sets. Remove these
ER.assoc <- ER.assoc[which(!ER.assoc %in% cilia.assoc)]

cilia_bar <- rownames(submat) %in% cilia.assoc
ER_bar <- rownames(submat) %in% ER.assoc
names_bar <- rownames(submat) %in% c(cilia.assoc, ER.assoc)
```

```{r}
p.mat <- dcast(p.quant, Protein~paste0(GROUP,'.',SUBJECT), value.var = 'newLogInts') %>% 
  as.matrix(rownames='Protein')

submat <- sweep(p.mat^2, 1, apply(p.mat^2, 1, max, na.rm=T), '/')

Heatmap(submat,
        col=colorRamp2(breaks=c(0,1), colors=c('white', 'firebrick')),
        cluster_rows = clusterWNA(submat))


submat <- PrepareProteinLinearMat(p.quant, dcast.formula = Protein~paste0(GROUP,'.',SUBJECT), logIntColumn = 'newLogInts', requireComplete = 0)

hm <- Heatmap(submat, 
        show_row_names = F,
        cluster_columns = F,
        cluster_column_slices = F,
        top_annotation = colAnn,
        show_column_names = F,
        clustering_distance_rows = 'pearson',
        row_title = sprintf('%s proteins', nrow(submat)),
        name='Ints/max Ints',
        column_split = list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat))),
        row_names_gp = gpar(fontsize=7),
        column_names_gp = gpar(fontsize=7),
        column_title_gp = gpar(fontsize=10, fontface='bold'),
        col = c("white", "firebrick")) +
  
   # barplot annotations
   Heatmap(cilia_bar + 0, name = "Cilium proteins", col = c("0" = "white", "1" = '#5ec962'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=10, fontface='bold'), column_gap = unit(0.01, "cm"), gap = unit(0.1, "cm"))  +
    Heatmap(ER_bar + 0, name = "Response to ER stress", col = c("0" = "white", "1" = '#414487FF'), border=T,
        show_heatmap_legend = FALSE, width = unit(4, "mm"), column_names_gp = gpar(fontsize=10, fontface='bold'), column_gap = unit(0.01, "cm"), gap = unit(0.1, "cm")) +
  rowAnnotation(link = anno_mark(at = which(names_bar), # gives row index of the items in names_bar
                                  labels = multiUniprots2multiGenes(rownames(linear.mat)[names_bar], species='MOUSE'),
                                  labels_gp = gpar(fontsize = 4), padding = unit(0.1, "mm"))) 

hm
BackupAsPDF(hm, 'allProts.linearScale.heatmap', dimensions = c(14,12))
```
Look at just the ciliated proteins

```{r}
cilia.mat <- submat[rownames(submat) %in% cilia.go,]

hm <- Heatmap(cilia.mat, 
        show_row_names = F,
        cluster_columns = F,
        cluster_column_slices = F,
        top_annotation = colAnn,
        show_column_names = F,
        clustering_distance_rows = 'pearson',
        row_title = sprintf('%s proteins', nrow(cilia.mat)),
        name='Ints/max Ints',
        column_split = list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(cilia.mat))),
        row_names_gp = gpar(fontsize=7),
        column_names_gp = gpar(fontsize=7),
        column_title_gp = gpar(fontsize=10, fontface='bold'),
        col = c("white", "firebrick")) 

hm
BackupAsPDF(hm, 'cilialProts.linearScale.heatmap', dimensions = c(14,12))
```
### Not used 

UpSet plot to look at overlaps in significant hits between the conditions
Need to create a binary matrix for input; use fromList argument
..
Leave out these as they are difficult to interpret,
Maybe useful in a smaller set, but not here...
```{r}
# example of list input (list of named vectors)
sigProtsList <- lapply(mss.dt[, .(Label, sig, Protein)] %>% 
  split(., .$Label), function(x){
    return(x[sig != 'not', Protein])
  })

up <- upset(fromList(sigProtsList[grep('[-]cilia_PM', names(sigProtsList))]),
      nsets = 12,
      mainbar.y.label = 'Number of Overlaps of Significant Proteins',
      sets.x.label = "Number Significant Proteins",
      sets.bar.color = "#56B4E9",
      order.by = c("freq"))
up
#BackupAsPDF(up, "noCilia_PM_denominator.upset", dimensions = c(10,10))


up <- upset(fromList(sigProtsList[grep('[+]cilia_PM', names(sigProtsList))]),
      nsets = 12,
      mainbar.y.label = 'Number of Overlaps of Significant Proteins',
      sets.x.label = "Number Significant Proteins",
      sets.bar.color = "#56B4E9",
      order.by = c("freq"))
```



```{r}
mss.dt[sig != 'not' & contrastGrp == 'noLigand_denominator', unique(Protein)]
```


```{r}
mss.dt[sig != 'not' & contrastGrp == 'noLigand_denominator', unique(Protein)]
```




cond.oi <- p.quant[contrastGrp == ]
p.mat <- dcast(p.quant[GROUP %in% cond.oi,], Protein~interaction(GROUP,SUBJECT), value.var = 'newLogInts') %>% 
  as.matrix(rownames='Protein')

submat <- p.mat[rownames(p.mat) %in% prots.oi,]

submat <- sweep(submat, 1, apply(submat,1,median,na.rm=T))

rownames(submat) <- multiUniprots2multiGenes(rownames(submat), species='MOUSE')

hm <- Heatmap(submat, 
              cluster_rows = clusterWNA(submat),
              cluster_columns=F,
              name='Ints./Median',
              border = T,
             # column_split=gsub('[.][0-9]{1}$','', colnames(submat)),
              column_split=list(gsub('[+-]cilia_|[.][0-9]{1}$','', colnames(submat)),
                                grep('[+-]{1}cilia', gsub('[_].+$','', colnames(submat)), value = T ) ),
              row_names_gp = gpar(fontsize=2),
              row_title = sprintf('%s DE proteins (log2FC >= 1 & adj.pval < 0.05', nrow(submat)),
              column_names_gp = gpar(label=F))
hm
BackupAsPDF(hm, 'sigProts.controlComparisons.medianScaled.heatmap', dimensions = c(12,18))
```


```{r}
p.mat <- dcast(p.quant, Protein~interaction(GROUP,SUBJECT), value.var = 'newLogInts') %>% 
  as.matrix(rownames='Protein')

submat <- p.mat[rownames(p.mat) %in% lit.prots,]

rownames(submat) <- multiUniprots2multiGenes(rownames(submat), species = 'MOUSE')

submat <-  sweep(submat, 1, apply(submat, 1, median,na.rm=T))

hm <- Heatmap(submat, 
        cluster_rows = clusterWNA(submat),
        name='Ints./Median',
        column_split=grepl('[+]cilia', colnames(submat)),
        column_title  = c('- Cilia', '+ Cilia'),
        row_names_gp = gpar(fontsize=3),
        column_names_gp = gpar(fontsize=6))

hm
BackupAsPDF(hm, 'litCiliaProteins.heatmap', dimensions=c(9,11))


hm <- Heatmap(submat, 
        cluster_rows = clusterWNA(submat),
        name='Ints./Median',
        column_split=gsub('.[0-9]{1}$','', colnames(submat)),
        row_names_gp = gpar(fontsize=3),
        column_names_gp = gpar(label=F))
hm
BackupAsPDF(hm, 'litCiliaProteins.colSplitheatmap', dimensions=c(17,11))

# drop rows with lots of NA values for 'cleaner' picture'
```

Differences